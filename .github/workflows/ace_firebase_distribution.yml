# CD-Firebase.yml - Firebase App Distribution ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: Firebase App Distribution CD

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
#on:
#  push:
#    branches:
#      - develop

jobs:
  firebase_distribution:
    name: Firebase App Distribution
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

#      - name: local.properties ì„¤ì •
#        run: |
#          echo "base.url=\"${{ secrets.BASE_URL }}\"" >> local.properties

      - name: google-services.json ì„¤ì •
        # Firebase ì„œë¹„ìŠ¤ì— í•„ìš”í•œ google-services.json íŒŒì¼ì„ Secretsì—ì„œ ê°€ì ¸ì™€ ë³µì›í•©ë‹ˆë‹¤.
        run: |
          echo "google-services.json íŒŒì¼ì„ ì„¤ì •í•©ë‹ˆë‹¤..."
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > ./app/google-services.json
          if [ -f ./app/google-services.json ]; then
            echo "google-services.jsonì´ ./app/google-services.jsonì— ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "ì˜¤ë¥˜: ./app/google-services.jsonì—ì„œ google-services.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
        shell: bash

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        # gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œì´ ì—†ìœ¼ë©´ ë¹Œë“œê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
        run: chmod +x ./gradlew

      - name: ë¦´ë¦¬ìŠ¤ APK ë¹Œë“œ (Firebase App Distributionìš©)
        # Firebase App Distributionì„ ìœ„í•´ ë¦´ë¦¬ìŠ¤ APKë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
        run: ./gradlew assembleRelease

      - name: Firebase App Distribution ì—…ë¡œë“œ
        # ë¹Œë“œëœ ë¦´ë¦¬ìŠ¤ APKë¥¼ Firebase App Distributionìœ¼ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
        uses: wzieba/Firebase-App-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          group: 'testers' # Firebase ì½˜ì†”ì—ì„œ ì„¤ì •ëœ í…ŒìŠ¤í„° ê·¸ë£¹ ì´ë¦„ ì§€ì •í•´ì•¼ë©ë‹ˆë‹¤.
          file: app/build/outputs/apk/release/app-release.apk

      - name: Slack ì•Œë¦¼ (Firebase ë°°í¬ ì„±ê³µ)
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: '#client-actions'
          SLACK_MESSAGE: "ğŸš€ Firebase App Distribution ë°°í¬ ì„±ê³µ! ë¸Œëœì¹˜: `${{ github.ref_name }}` ì»¤ë°‹: `${{ github.sha }}`"

      - name: Slack ì•Œë¦¼ (Firebase ë°°í¬ ì‹¤íŒ¨)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: '#client-actions'
          SLACK_MESSAGE: "ğŸš¨ Firebase App Distribution ë°°í¬ ì‹¤íŒ¨! ë¸Œëœì¹˜: `${{ github.ref_name }}` ì»¤ë°‹: `${{ github.sha }}`"
          SLACK_COLOR: 'danger'
