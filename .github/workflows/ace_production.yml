# CD-GooglePlay-Production.yml - Google Play Console í”„ë¡œë•ì…˜ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: Google Play Production Release CD

## ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
#on:
#  push:
#    tags:
#      - 'v*' # 'v'ë¡œ ì‹œì‘í•˜ëŠ” íƒœê·¸(ì˜ˆ: v1.0.0)ê°€ í‘¸ì‹œë˜ì—ˆì„ ë•Œë§Œ íŠ¸ë¦¬ê±°

jobs:
  google_play_production:
    name: Google Play Production Release
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: local.properties ì„¤ì •
        run: |
          echo "base.url=\"${{ secrets.BASE_URL }}\"" >> local.properties
          echo "cloud.vision.api.key=\"${{ secrets.CLOUD_VISION_API_KEY }}\"" >> local.properties

      - name: google-services.json ì„¤ì •
        # Firebase ì„œë¹„ìŠ¤ì— í•„ìš”í•œ google-services.json íŒŒì¼ì„ Secretsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        run: |
          echo "google-services.json íŒŒì¼ì„ ì„¤ì •í•©ë‹ˆë‹¤..."
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > ./app/google-services.json
          if [ -f ./app/google-services.json ]; then
            echo "google-services.jsonì´ ./app/google-services.jsonì— ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "ì˜¤ë¥˜: ./app/google-services.jsonì—ì„œ google-services.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
        shell: bash

      - name: ì¶œì‹œ ì„œëª… í‚¤ ì„¤ì •
        # Android App Bundle ì„œëª…ì„ ìœ„í•œ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©ëœ Secretsì—ì„œ ë””ì½”ë”©í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
        run: |
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > android_signing_key.jks

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ë¦´ë¦¬ìŠ¤ AAB ë¹Œë“œ (Google Play í”„ë¡œë•ì…˜ìš©)
        # Google Play Console ë°°í¬ë¥¼ ìœ„í•´ ë¦´ë¦¬ìŠ¤ AABë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
        run: ./gradlew bundleRelease
        env:
          # ì„œëª… í™˜ê²½ ë³€ìˆ˜
          ORG_GRADLE_PROJECT_signingStoreFile: android_signing_key.jks
          ORG_GRADLE_PROJECT_signingKeyAlias: ${{ secrets.SIGNING_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_signingKeyPassword: ${{ secrets.SIGNING_KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_signingStorePassword: ${{ secrets.SIGNING_STORE_PASSWORD }}

      - name: Google Play Console í”„ë¡œë•ì…˜ ë°°í¬
        # ë¹Œë“œëœ ë¦´ë¦¬ìŠ¤ AABë¥¼ Google Play Console í”„ë¡œë•ì…˜ íŠ¸ë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}
          packageName: your.package.name # ì„œë¹„ìŠ¤ëª… í™•ì • í›„ ì•±ì˜ ì‹¤ì œ íŒ¨í‚¤ì§€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
          releaseFile: app/build/outputs/bundle/release/app-release.aab
          track: production # í”„ë¡œë•ì…˜ íŠ¸ë™ìœ¼ë¡œ ì§€ì •
          status: completed # ì¶œì‹œ ìƒíƒœë¥¼ 'completed'ë¡œ ì„¤ì •í•˜ì—¬ ì¦‰ì‹œ ì¶œì‹œë˜ë„ë¡ í•©ë‹ˆë‹¤.

      - name: Slack ì•Œë¦¼ (Google Play í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: workflow,job,commit,repo,author,took,ref
          author_name: GitHub Actions
          text: "ğŸš€ Google Play í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ! íƒœê·¸: `${{ github.ref_name }}` ì»¤ë°‹: `${{ github.sha }}`"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack ì•Œë¦¼ (Google Play í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: workflow,job,commit,repo,author,took,ref
          author_name: GitHub Actions
          text: "ğŸš¨ Google Play í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨! íƒœê·¸: `${{ github.ref_name }}` ì»¤ë°‹: `${{ github.sha }}`"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
