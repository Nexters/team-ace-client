# CD-GooglePlay-Internal.yml - Google Play Console ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: Google Play Internal Test CD

#on:
#  push:
#    branches:
#      - main

jobs:
  google_play_internal:
    name: Google Play Internal Test
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

#      - name: local.properties ì„¤ì •
#        run: |
#          echo "base.url=\"${{ secrets.BASE_URL }}\"" >> local.properties

      - name: google-services.json ì„¤ì •
        # Firebase ì„œë¹„ìŠ¤ì— í•„ìš”í•œ google-services.json íŒŒì¼ì„ Secretsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        run: |
          echo "google-services.json íŒŒì¼ì„ ì„¤ì •í•©ë‹ˆë‹¤..."
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > ./app/google-services.json
          if [ -f ./app/google-services.json ]; then
            echo "google-services.jsonì´ ./app/google-services.jsonì— ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "ì˜¤ë¥˜: ./app/google-services.jsonì—ì„œ google-services.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
        shell: bash

      - name: ì¶œì‹œ ì„œëª… í‚¤ ì„¤ì •
        # Android App Bundle ì„œëª…ì„ ìœ„í•œ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©ëœ Secretsì—ì„œ ë””ì½”ë”©í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
        # SIGNING_KEY_BASE64ëŠ” GitHub Actions Secretsì— ë¯¸ë¦¬ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        run: |
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > android_signing_key.jks
        # í‚¤ìŠ¤í† ì–´ íŒŒì¼ì˜ ë¹„ë°€ë²ˆí˜¸, ë³„ì¹­ ë“±ì€ Secretsì— ë³„ë„ë¡œ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ë¦´ë¦¬ìŠ¤ AAB ë¹Œë“œ (Google Play ë‚´ë¶€ í…ŒìŠ¤íŠ¸ìš©)
        # Google Play Console ë°°í¬ë¥¼ ìœ„í•´ ë¦´ë¦¬ìŠ¤ AAB(Android App Bundle)ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
        run: ./gradlew bundleRelease
        env:
          # Gradleì— ì„œëª… ì •ë³´ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
          ORG_GRADLE_PROJECT_signingStoreFile: android_signing_key.jks
          ORG_GRADLE_PROJECT_signingKeyAlias: ${{ secrets.SIGNING_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_signingKeyPassword: ${{ secrets.SIGNING_KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_signingStorePassword: ${{ secrets.SIGNING_STORE_PASSWORD }}

      - name: Google Play Console ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬
        # ë¹Œë“œëœ ë¦´ë¦¬ìŠ¤ AABë¥¼ Google Play Console ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.
        # r0adkll/upload-google-play ì•¡ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }} # Google Play ì„œë¹„ìŠ¤ ê³„ì • JSON (Base64 ì¸ì½”ë”©ëœ ë‚´ìš©)
          packageName: your.package.name # ì„œë¹„ìŠ¤ëª… í™•ì • í›„ ì•±ì˜ ì‹¤ì œ íŒ¨í‚¤ì§€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
          releaseFile: app/build/outputs/bundle/release/app-release.aab
          track: internal

      - name: Slack ì•Œë¦¼ (Google Play ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ì„±ê³µ)
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: '#client-actions'
          SLACK_MESSAGE: "ğŸš€ Google Play ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì„±ê³µ! ë¸Œëœì¹˜: `${{ github.ref_name }}` ì»¤ë°‹: `${{ github.sha }}`"

      - name: Slack ì•Œë¦¼ (Google Play ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: '#client-actions'
          SLACK_MESSAGE: "ğŸš¨ Google Play ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì‹¤íŒ¨! ë¸Œëœì¹˜: `${{ github.ref_name }}` ì»¤ë°‹: `${{ github.sha }}`"
          SLACK_COLOR: 'danger'